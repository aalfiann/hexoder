<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Best Practice to Create Rest API With TotalJS Framework · Hexoder</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Best Practice to Create Rest API With TotalJS Framework - M ABD AZIZ ALFIAN"><meta name="keywords" content="learning-javascript, tutorial-javascript, learning-nodejs, tutorial-nodejs, elementary-os, linux"><meta name="author" content="M ABD AZIZ ALFIAN"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/css/bubuzou.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://hexoder.com/atom.xml" title="Hexoder"><script src="//cdn.jsdelivr.net/npm/text-obfuscator@1.0.2/dist/text-obfuscator.min.js"></script><script>function parse_query_string(e){for(var o=e.replace("?","").split("&"),n={},r=0;r<o.length;r++){var t=o[r].split("="),i=decodeURIComponent(t[0]),a=decodeURIComponent(t[1]);if(void 0===n[i])n[i]=decodeURIComponent(a);else if("string"==typeof n[i]){var l=[n[i],decodeURIComponent(a)];n[i]=l}else n[i].push(decodeURIComponent(a))}return n}function removeParam(e,o){var n=o.split("?")[0],r=[],t=-1!==o.indexOf("?")?o.split("?")[1]:"";if(""!==t){for(var i=(r=t.split("&")).length-1;0<=i;i-=1)r[i].split("=")[0]===e&&r.splice(i,1);0<r.length?n=n+"?"+r.join("&"):n+=r.join("&")}return n}var hash=parse_query_string(window.location.search).to;if(hash){var link=TextObfuscator.decode(hash,3),newurl=removeParam("to",window.location.href);newurl=newurl.replace(window.location.origin,""),window.history.replaceState({},document.title,newurl)}</script><script data-ad-client="ca-pub-8811888720849913" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><header><div class="header row"><a class="logo-link" href="/"><img src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/images/logo-landscape.png"></a><ul class="nav nav-list" id="nav_list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self" data-hover="HOME">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self" data-hover="ABOUT">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self" data-hover="ARCHIVES">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/contact" target="_self" data-hover="CONTACT">CONTACT</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div class="nav-btn" id="nav_btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><div id="safelinker1"></div><div class="post" id="postAr"><article class="post-block"><h1 class="post-title">Best Practice to Create Rest API With TotalJS Framework</h1><div class="post-info">2019-12-08</div><div class="post-content"><p><img src="https://i.imgur.com/opyqRaa.jpg" alt=""></p><p>Hello guys, this time I will write an article about Best Practice to Create Rest API with TotalJS Framework.<br>We already know that there is an example <a href="https://github.com/totaljs/emptyproject-restservice" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">emptyproject-restservice</a> from official TotalJS documentaion. But it example only give us the simple way to create a rest api with TotalJS. Simple way doesn’t same meaning with best practice way. So how the best practice way to create rest api with TotalJS framework?</p><a id="more"></a><h2 id="What-is-the-goal"><a href="#What-is-the-goal" class="headerlink" title="What is the goal?"></a>What is the goal?</h2><p>Before we start to create a basic rest api with TotalJS framework. We will create an empty skeleton for rest api, which is this skeleton will be benefit for us to be use in every new project. I also will upload this project on my github, so you can just download this skeleton again and again in the future.</p><p>So here is the goals of this skeleton :</p><ul><li>An empty rest api project</li><li>No default session (you are free to use what session method for your project)</li><li>Use standard <code>uuid</code> and <code>bcrypt</code> for better security</li><li>Use middleware for custom header x-token</li><li>Use models as schemas</li><li>Json response is standardized</li><li>Code must be clean and readable</li><li>Best practice way</li></ul><h2 id="Make-a-skeleton"><a href="#Make-a-skeleton" class="headerlink" title="Make a skeleton"></a>Make a skeleton</h2><p>Now for the first time, I will create new project name <code>totaljs-rest-skeleton</code>.</p><ul><li>Create the <code>package.json</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm init</span><br></pre></td></tr></table></figure></li></ul><p>After generate the <code>package.json</code> with <code>NPM init</code>, so here is my package.json:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"totaljs-rest-skeleton"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"TotalJS Rest Skeleton with best practice way"</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"debug.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git+https://github.com/aalfiann/totaljs-rest-skeleton.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"keywords"</span>: [</span><br><span class="line">    <span class="string">"totaljs"</span>,</span><br><span class="line">    <span class="string">"totaljs-rest"</span>,</span><br><span class="line">    <span class="string">"totaljs-rest-api"</span>,</span><br><span class="line">    <span class="string">"totaljs-rest-skeleton"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">"M ABD AZIZ ALFIAN"</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">  <span class="string">"bugs"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"https://github.com/aalfiann/totaljs-rest-skeleton/issues"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"homepage"</span>: <span class="string">"https://github.com/aalfiann/totaljs-rest-skeleton#readme"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Install <code>total.js</code>, <code>uuid</code> and <code>bcryptjs</code> from NPM<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install total.js uuid bcryptjs</span><br></pre></td></tr></table></figure></li></ul><p>After install required library successfully, if you take a look in your <code>package.json</code> file, now it’s added new line.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dependencies"</span>: &#123;</span><br><span class="line">  <span class="string">"bcryptjs"</span>: <span class="string">"^2.4.3"</span>,</span><br><span class="line">  <span class="string">"total.js"</span>: <span class="string">"^3.3.2"</span>,</span><br><span class="line">  <span class="string">"uuid"</span>: <span class="string">"^3.3.3"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now let’s we continue to the next step.</p><h3 id="Directory-Structure"><a href="#Directory-Structure" class="headerlink" title="Directory Structure"></a>Directory Structure</h3><p>The project is still empty, so now we must create the directory structure plan first.</p><ul><li>controllers/<ul><li>api.js</li><li>default.js</li></ul></li><li>definitions/<ul><li>app_helper.js</li><li>middleware.js</li></ul></li><li>models/<ul><li>account.js</li></ul></li><li>.gitignore</li><li>config</li><li>debug.js</li><li>LICENSE</li><li>package.json</li><li>postman.json</li><li>readme.md</li><li>release.js</li><li>test.js</li></ul><p>The above directory structure is we will create a rest api skeleton with MVC architecture. This design is follow the documentation from TotalJS.</p><h3 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h3><p><code>.gitignore</code> is required to prevent the files which is doesn’t need to upload into github repository. In this skeleton, I just prevent the <code>node_modules</code> and <code>package-lock.json</code> to be uploaded into github repository.</p><p>So the <code>.gitignore</code> file is must be like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node_modules</span><br><span class="line">package-lock.json</span><br><span class="line">databases</span><br><span class="line">tmp</span><br></pre></td></tr></table></figure><h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><p><code>config</code> file is to set the default settings for application. In this skeleton, I just set for default variables.</p><p>So the <code>config</code> file is like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name                            : Total.js Rest Skeleton</span><br><span class="line">author                          : M ABD AZIZ ALFIAN (https:<span class="comment">//github.com/aalfiann)</span></span><br><span class="line">version                         : <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">api_xtoken                      : <span class="number">12345678</span></span><br></pre></td></tr></table></figure><p>Note:</p><ul><li>Config <code>key</code> must be no any space and must be string.</li><li>Config <code>value</code> could be <code>Object</code>, <code>json</code>, <code>number</code>, <code>boolean</code>, <code>date</code>, <code>array</code>, <code>env</code> or <code>config linking</code>.</li></ul><p>Example config:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">custom_config_object_raw      (<span class="built_in">Object</span>)    : &#123; <span class="attr">name</span>: <span class="string">'Total.js'</span>, <span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>() &#125;</span><br><span class="line">custom_config_object_json     (<span class="built_in">JSON</span>)      : &#123; <span class="string">"name"</span>: <span class="string">"Total.js"</span> &#125;</span><br><span class="line">custom_config_number          (number)    : <span class="number">320.34</span></span><br><span class="line">custom_config_boolean         (boolean)   : <span class="literal">true</span></span><br><span class="line">custom_config_date            (date)      : <span class="number">2016</span><span class="number">-07</span><span class="number">-26</span></span><br><span class="line">custom_config_array           (array)     : [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">binds_environment_value       (env)       : APP_NAME</span><br><span class="line"></span><br><span class="line"><span class="comment">// +v2.9.0 supports config linking</span></span><br><span class="line">binds_config_value            (config)    : name</span><br></pre></td></tr></table></figure><p>For more detail about config, please see at <a href="https://docs.totaljs.com/latest/en.html#api~FrameworkConfiguration" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">here</a></p><h3 id="debug-js"><a href="#debug-js" class="headerlink" title="debug.js"></a>debug.js</h3><p><code>debug.js</code> file is to run TotalJS framework as debug mode.</p><p>Create <code>debug.js</code> file is very simple as like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"><span class="comment">// FOR DEVELOPMENT</span></span><br><span class="line"><span class="comment">// Total.js - framework for Node.js platform</span></span><br><span class="line"><span class="comment">// https://www.totaljs.com</span></span><br><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// options.ip = '127.0.0.1';</span></span><br><span class="line"><span class="comment">// options.port = parseInt(process.argv[2]);</span></span><br><span class="line"><span class="comment">// options.config = &#123; name: 'Total.js' &#125;;</span></span><br><span class="line"><span class="comment">// options.sleep = 3000;</span></span><br><span class="line"><span class="comment">// options.inspector = 9229;</span></span><br><span class="line"><span class="comment">// options.watch = ['private'];</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'total.js/debug'</span>)(options);</span><br></pre></td></tr></table></figure><p>To run this <code>debug.js</code> in TotalJS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node debug.js</span><br></pre></td></tr></table></figure><p>Now your application is running with debug mode.</p><p>What is debug.js used for? When you are still in development progress, if there is an update or refactor in your code, application will update it automatically without have to restart the current service.</p><h3 id="release-js"><a href="#release-js" class="headerlink" title="release.js"></a>release.js</h3><p><code>release.js</code> file is to run TotalJS framework as release mode.</p><p>Create <code>release.js</code> file is very simple as like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"><span class="comment">// FOR PRODUCTION</span></span><br><span class="line"><span class="comment">// Total.js - framework for Node.js platform</span></span><br><span class="line"><span class="comment">// https://www.totaljs.com</span></span><br><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// options.ip = '127.0.0.1';</span></span><br><span class="line"><span class="comment">// options.port = parseInt(process.argv[2]);</span></span><br><span class="line"><span class="comment">// options.config = &#123; name: 'Total.js' &#125;;</span></span><br><span class="line"><span class="comment">// options.sleep = 3000;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'total.js'</span>).http(<span class="string">'release'</span>, options);</span><br><span class="line"><span class="comment">// require('total.js').cluster.http(5, 'release', options);</span></span><br></pre></td></tr></table></figure><p>To run this <code>release.js</code> in TotalJS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node release.js</span><br></pre></td></tr></table></figure><p>Now your application is running with release mode.</p><p>What is release.js used for? When you are have complete the development progress, you can just run the stable version of your code. If there is an update or refactor in your code, application will not update it automatically and you also have to restart the current service.</p><h3 id="test-js"><a href="#test-js" class="headerlink" title="test.js"></a>test.js</h3><p><code>test.js</code> file is to run TotalJS framework as unit test mode.</p><p>Create <code>test.js</code> file is very simple as like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"><span class="comment">// FOR UNIT-TESTING</span></span><br><span class="line"><span class="comment">// Total.js - framework for Node.js platform</span></span><br><span class="line"><span class="comment">// https://www.totaljs.com</span></span><br><span class="line"><span class="comment">// ===================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// options.ip = '127.0.0.1';</span></span><br><span class="line"><span class="comment">// options.port = parseInt(process.argv[2]);</span></span><br><span class="line"><span class="comment">// options.config = &#123; name: 'Total.js' &#125;;</span></span><br><span class="line"><span class="comment">// options.sleep = 3000;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'total.js'</span>).http(<span class="string">'test'</span>, options);</span><br></pre></td></tr></table></figure><p>To run this <code>test.js</code> in TotalJS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node test.js</span><br></pre></td></tr></table></figure><p>Now your application is running as unit test mode.</p><p>What is <code>test.js</code> used for? TotalJS framework has it own unit test feature, so test mode will only execute the unit test and get the result for you in seconds.</p><h3 id="LICENSE"><a href="#LICENSE" class="headerlink" title="LICENSE"></a>LICENSE</h3><p><code>license</code> type file will using <code>MIT</code>, so that everyone will more freedom to use this rest api skeleton in their projects.</p><p>Example MIT License:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Copyright 2019 M ABD AZIZ ALFIAN</span><br><span class="line"></span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span><br><span class="line"></span><br><span class="line">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span><br><span class="line"></span><br><span class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span><br></pre></td></tr></table></figure><h3 id="readme-md"><a href="#readme-md" class="headerlink" title="readme.md"></a>readme.md</h3><p><code>Readme.md</code> file is must be written about your detail project information.</p><p>For default <code>readme.md</code> file is like this</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># totaljs-rest-skeleton</span><br><span class="line">TotalJS Rest Skeleton with best practice way  </span><br><span class="line"></span><br><span class="line">## How to use</span><br><span class="line">- Download and extract this project</span><br><span class="line">- open terminal / command-line</span><br><span class="line">- go to extracted directory</span><br><span class="line">- install the library from NPM `$ npm install`</span><br><span class="line">- run `$ node debug.js`</span><br><span class="line">- open browser `http://127.0.0.1:8000`</span><br><span class="line"></span><br><span class="line">## How to test the Rest API</span><br><span class="line">- make sure you are able to open browser `http://127.0.0.1:8000`</span><br><span class="line">- open postman app</span><br><span class="line">- import collection `postman.json`</span><br><span class="line">- done, now you are able to make test the rest api</span><br></pre></td></tr></table></figure><h3 id="definitions-app-helper-js"><a href="#definitions-app-helper-js" class="headerlink" title="definitions/app_helper.js"></a>definitions/app_helper.js</h3><p>Now I will create an <code>app_helper.js</code>, this is used for modify the default response become standardize json response.</p><p>So you can just copy paste the class below here :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    schemaErrorBuilder,</span><br><span class="line">    builderErrorResponse,</span><br><span class="line">    successResponse,</span><br><span class="line">    failResponse,</span><br><span class="line">    customResponse,</span><br><span class="line">    cryptPassword,</span><br><span class="line">    comparePassword</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Modify error from schema</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; name     this is the error key name </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schemaErrorBuilder</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ErrorBuilder.addTransform(name, <span class="function"><span class="keyword">function</span>(<span class="params">isResponse</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> builder = [];</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = <span class="keyword">this</span>.items.length; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> err = <span class="keyword">this</span>.items[i];</span><br><span class="line">            builder.push(&#123;<span class="attr">name</span>:err.name,<span class="attr">error</span>:err.error&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (isResponse) &#123;</span><br><span class="line">            <span class="keyword">this</span>.status = <span class="number">400</span>;</span><br><span class="line">            <span class="keyword">if</span> (builder.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                    code:<span class="keyword">this</span>.status,</span><br><span class="line">                    status:<span class="string">'error'</span>,</span><br><span class="line">                    message:<span class="string">'Invalid parameter'</span>,</span><br><span class="line">                    error:builder</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.status = <span class="number">500</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                    code:<span class="keyword">this</span>.status,</span><br><span class="line">                    status:<span class="string">'error'</span>,</span><br><span class="line">                    message:<span class="string">'Something went wrong...'</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Database builder error response</span></span><br><span class="line"><span class="comment"> * @param &#123;controller&#125; $        this is the totaljs controller</span></span><br><span class="line"><span class="comment"> * @return &#123;callback&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">builderErrorResponse</span>(<span class="params">$,err</span>)</span>&#123;</span><br><span class="line">    $.controller.status = <span class="number">409</span>;</span><br><span class="line">    $.callback(<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">        code:<span class="number">409</span>,</span><br><span class="line">        status:<span class="string">'error'</span>,</span><br><span class="line">        message:<span class="string">'Something went wrong...'</span>,</span><br><span class="line">        error:err</span><br><span class="line">    &#125;)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Response success </span></span><br><span class="line"><span class="comment"> * @param &#123;controller&#125; $        this is the totaljs controller</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; message      this is the message of response</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; response          this is the response detail</span></span><br><span class="line"><span class="comment"> * @return &#123;callback&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">successResponse</span> (<span class="params">$,message, response=[]</span>) </span>&#123;</span><br><span class="line">    $.controller.status = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">var</span> success = &#123;</span><br><span class="line">        <span class="string">'code'</span>:<span class="number">200</span>,</span><br><span class="line">        <span class="string">'status'</span>:<span class="string">'success'</span>,</span><br><span class="line">        <span class="string">'message'</span>:message,</span><br><span class="line">        <span class="string">'response'</span>:response</span><br><span class="line">    &#125;</span><br><span class="line">    $.callback(<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(success)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Response fail </span></span><br><span class="line"><span class="comment"> * @param &#123;controller&#125; $        this is the totaljs controller</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; message      this is the message of response</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; response          this is the response detail</span></span><br><span class="line"><span class="comment"> * @return &#123;callback&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">failResponse</span> (<span class="params">$, message, response=[]</span>) </span>&#123;</span><br><span class="line">    $.controller.status = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">var</span> fail = &#123;</span><br><span class="line">        <span class="string">'code'</span>:<span class="number">200</span>,</span><br><span class="line">        <span class="string">'status'</span>:<span class="string">'error'</span>,</span><br><span class="line">        <span class="string">'message'</span>:message,</span><br><span class="line">        <span class="string">'response'</span>:response</span><br><span class="line">    &#125;</span><br><span class="line">    $.callback(<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(fail)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Response custom </span></span><br><span class="line"><span class="comment"> * @param &#123;controller&#125; $        this is the totaljs controller</span></span><br><span class="line"><span class="comment"> * @param &#123;int&#125; code            this is the http code you want to sent in response header</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; status       this is the status you want to sent in response body</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; message      this is the message of response</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; response          this is the response detail</span></span><br><span class="line"><span class="comment"> * @param &#123;bool&#125; isError        this is the type of success or error response</span></span><br><span class="line"><span class="comment"> * @return &#123;callback&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customResponse</span> (<span class="params">$, code, status, message, response=[], isError=false</span>) </span>&#123;</span><br><span class="line">    $.controller.status = code;</span><br><span class="line">    <span class="keyword">var</span> custom = &#123;</span><br><span class="line">        <span class="string">'code'</span>:code,</span><br><span class="line">        <span class="string">'status'</span>:status,</span><br><span class="line">        <span class="string">'message'</span>:message</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(response !== <span class="literal">undefined</span> &amp;&amp; response !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span>(isError) &#123;</span><br><span class="line">            name = <span class="string">'error'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            name = <span class="string">'response'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        custom[name] = response;</span><br><span class="line">    &#125;</span><br><span class="line">    $.callback(<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(custom)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Encrypt password</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; password     this is the user password </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; callback</span></span><br><span class="line"><span class="comment"> * @return &#123;callback&#125; </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cryptPassword</span>(<span class="params">password, callback</span>) </span>&#123;</span><br><span class="line">    bcrypt.genSalt(<span class="number">10</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, salt</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (err) </span><br><span class="line">       <span class="keyword">return</span> callback(err);</span><br><span class="line"> </span><br><span class="line">     bcrypt.hash(password, salt, <span class="function"><span class="keyword">function</span>(<span class="params">err, hash</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> callback(err, hash);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Compare password</span></span><br><span class="line"><span class="comment">  * @param &#123;string&#125; plainPass        this is the user password </span></span><br><span class="line"><span class="comment">  * @param &#123;string&#125; hashword         this is the hashed user password</span></span><br><span class="line"><span class="comment">  * @param &#123;*&#125; callback </span></span><br><span class="line"><span class="comment">  * @return &#123;callback&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">comparePassword</span>(<span class="params">plainPass, hashword, callback</span>) </span>&#123;</span><br><span class="line">    bcrypt.compare(plainPass, hashword, <span class="function"><span class="keyword">function</span>(<span class="params">err, isPasswordMatch</span>) </span>&#123;   </span><br><span class="line">        <span class="keyword">return</span> err == <span class="literal">null</span> ?</span><br><span class="line">            callback(<span class="literal">null</span>, isPasswordMatch) :</span><br><span class="line">            callback(err);</span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><h3 id="definitions-middleware-js"><a href="#definitions-middleware-js" class="headerlink" title="definitions/middleware.js"></a>definitions/middleware.js</h3><p>Now I will create the default middleware for authenticate the API.</p><p>So you can just create the file <code>middleware.js</code> then copy paste this code below:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authenticate api</span></span><br><span class="line">MIDDLEWARE(<span class="string">'auth_api'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line">    $.controller.req.headers[<span class="string">'x_token'</span>] = ($.controller.req.headers[<span class="string">'x_token'</span>] == <span class="literal">undefined</span>)?<span class="string">''</span>:$.controller.req.headers[<span class="string">'x_token'</span>];</span><br><span class="line">    <span class="keyword">if</span>($.controller.req.headers[<span class="string">'x_token'</span>] == F.config.api_xtoken) &#123;</span><br><span class="line">        $.next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $.controller.status = <span class="number">401</span>;</span><br><span class="line">        $.controller.json(&#123;<span class="attr">code</span>:<span class="number">401</span>,<span class="attr">status</span>:<span class="string">'error'</span>,<span class="attr">message</span>:<span class="string">'You\'re not authorized to use this API!'</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="models-account-js"><a href="#models-account-js" class="headerlink" title="models/account.js"></a>models/account.js</h3><p>Here is the models for <code>account</code>.</p><ul><li>create <code>account.js</code> then just copy paste this code below:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helper = <span class="built_in">require</span>(F.path.definitions(<span class="string">'app_helper'</span>));</span><br><span class="line"><span class="keyword">const</span> uuidv4 = <span class="built_in">require</span>(<span class="string">'uuid/v4'</span>);</span><br><span class="line"></span><br><span class="line">NEWSCHEMA(<span class="string">'Account'</span>).make(<span class="function"><span class="keyword">function</span>(<span class="params">schema</span>) </span>&#123;</span><br><span class="line">    schema.define(<span class="string">'username'</span>, <span class="string">'string'</span>);</span><br><span class="line">    schema.define(<span class="string">'password'</span>, <span class="string">'string'</span>);</span><br><span class="line">    schema.define(<span class="string">'email'</span>, <span class="string">'string'</span>);</span><br><span class="line"></span><br><span class="line">    schema.required(<span class="string">'username,password'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">model, op</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> (op.login == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">case</span> (op.register == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    schema.required(<span class="string">'email'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">model, op</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> op.register;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Listen schema validation error from totaljs</span></span><br><span class="line">    helper.schemaErrorBuilder(<span class="string">'custom'</span>);</span><br><span class="line">    schema.setError(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123; error.setTransform(<span class="string">'custom'</span>) &#125;);</span><br><span class="line"></span><br><span class="line">    schema.addWorkflow(<span class="string">'register'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = $.model.$clean();</span><br><span class="line">        <span class="keyword">var</span> username = data.username.toString().toLowerCase();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nosql = NOSQL(<span class="string">'user_data'</span>);</span><br><span class="line"></span><br><span class="line">        nosql.find().make(<span class="function"><span class="keyword">function</span>(<span class="params">builder</span>) </span>&#123;</span><br><span class="line">            builder.where(<span class="string">'username'</span>, username);</span><br><span class="line">            builder.callback(<span class="function"><span class="keyword">function</span>(<span class="params">err, response, count</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(err) helper.builderErrorResponse($,err);</span><br><span class="line">                <span class="keyword">if</span> (count) &#123;</span><br><span class="line">                    helper.failResponse($,<span class="string">'Sorry, Username is already exists!'</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    helper.cryptPassword(data.password,<span class="function"><span class="keyword">function</span>(<span class="params">err,hash</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(err) helper.customResponse($,<span class="number">409</span>,<span class="string">'error'</span>,<span class="string">'Failed to encrypt password!'</span>,err,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> inputdata = &#123;</span><br><span class="line">                            id:uuidv4(),</span><br><span class="line">                            username:username,</span><br><span class="line">                            hash:hash,</span><br><span class="line">                            email:data.email,</span><br><span class="line">                            date_created:<span class="built_in">Date</span>.now()</span><br><span class="line">                        &#125;;</span><br><span class="line">                        </span><br><span class="line">                        nosql.insert(inputdata).callback(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                                helper.builderErrorResponse($,err);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                helper.successResponse($,<span class="string">'Register is successfully!'</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    schema.addWorkflow(<span class="string">'login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = $.model.$clean();</span><br><span class="line">        <span class="keyword">var</span> nosql = NOSQL(<span class="string">'user_data'</span>);</span><br><span class="line">        nosql.find().make(<span class="function"><span class="keyword">function</span>(<span class="params">builder</span>) </span>&#123;</span><br><span class="line">            builder.where(<span class="string">'username'</span>, data.username.toString().toLowerCase());</span><br><span class="line">            builder.callback(<span class="function"><span class="keyword">function</span>(<span class="params">err,response,count</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(err) helper.builderErrorResponse($,err);</span><br><span class="line">                <span class="keyword">if</span>(count) &#123;</span><br><span class="line">                    <span class="keyword">var</span> user = response[<span class="number">0</span>];</span><br><span class="line">                    helper.comparePassword(data.password,user.hash, <span class="function"><span class="keyword">function</span>(<span class="params">err,isPasswordMatch</span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(err) helper.customResponse($,<span class="number">409</span>,<span class="string">'error'</span>,<span class="string">'Failed to compare password!'</span>,err,<span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">if</span>(isPasswordMatch) &#123;</span><br><span class="line">                            helper.successResponse($,<span class="string">'Login successful'</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            helper.failResponse($,<span class="string">'Wrong username or password!'</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    helper.failResponse($,<span class="string">'Wrong username or password!'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul><p>I just create example models only for an account to <code>register</code> and <code>login</code>. You have to create how to <code>logout</code> by yourself, because in this skeleton, there is no session.</p><h3 id="controllers-api-js"><a href="#controllers-api-js" class="headerlink" title="controllers/api.js"></a>controllers/api.js</h3><p>Now I will create the controller for route to the account.js models.</p><ul><li>create <code>api.js</code> then just copy and paste this code below:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exports.install = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sets cors for the entire API</span></span><br><span class="line">	CORS();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Account</span></span><br><span class="line">  ROUTE(<span class="string">'/api/account/register'</span>, [<span class="string">'post'</span>,<span class="string">'*Account --&gt; @register'</span>,<span class="string">'#auth_api'</span>]);</span><br><span class="line">  ROUTE(<span class="string">'/api/account/login'</span>, [<span class="string">'post'</span>,<span class="string">'*Account --&gt; @login'</span>,<span class="string">'#auth_api'</span>]);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>That is very clean right. There is no need extra line code for logic. It was already handled by <code>Schemas</code> in <code>models/</code> directory.</p><h3 id="controller-default-js"><a href="#controller-default-js" class="headerlink" title="controller/default.js"></a>controller/default.js</h3><p><code>default.js</code> in controller is just create plain view to tell your visitor about your api website.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exports.install = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  ROUTE(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">this</span>.plain(<span class="string">'REST Service &#123;0&#125;\nVersion: &#123;1&#125;'</span>.format(CONF.name, CONF.version))&#125;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="postman-json"><a href="#postman-json" class="headerlink" title="postman.json"></a>postman.json</h3><p><code>postman.json</code> is the file for using with postman app to test the request api. You have to import this file into your postman app. Then you are able to make a test your rest api.</p><ul><li>You just copy paste this postman.json<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"info"</span>: &#123;</span><br><span class="line">		<span class="string">"_postman_id"</span>: <span class="string">"f0efd831-06c7-4d07-ad6e-aaad9d0b682a"</span>,</span><br><span class="line">		<span class="string">"name"</span>: <span class="string">"totaljs-rest-skeleton"</span>,</span><br><span class="line">		<span class="string">"schema"</span>: <span class="string">"https://schema.getpostman.com/json/collection/v2.1.0/collection.json"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"item"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"Register"</span>,</span><br><span class="line">			<span class="string">"request"</span>: &#123;</span><br><span class="line">				<span class="string">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">				<span class="string">"header"</span>: [</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="string">"key"</span>: <span class="string">"Content-Type"</span>,</span><br><span class="line">						<span class="string">"name"</span>: <span class="string">"Content-Type"</span>,</span><br><span class="line">						<span class="string">"value"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">						<span class="string">"type"</span>: <span class="string">"text"</span></span><br><span class="line">					&#125;,</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="string">"key"</span>: <span class="string">"x_token"</span>,</span><br><span class="line">						<span class="string">"value"</span>: <span class="string">"12345678"</span>,</span><br><span class="line">						<span class="string">"type"</span>: <span class="string">"text"</span></span><br><span class="line">					&#125;</span><br><span class="line">				],</span><br><span class="line">				<span class="string">"body"</span>: &#123;</span><br><span class="line">					<span class="string">"mode"</span>: <span class="string">"raw"</span>,</span><br><span class="line">					<span class="string">"raw"</span>: <span class="string">"&#123;\n\t\"username\":\"admin\",\n\t\"password\":\"12345678\",\n\t\"email\":\"admin@yourdomain.com\"\n&#125;"</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"url"</span>: &#123;</span><br><span class="line">					<span class="string">"raw"</span>: <span class="string">"http://127.0.0.1:8000/api/account/register"</span>,</span><br><span class="line">					<span class="string">"protocol"</span>: <span class="string">"http"</span>,</span><br><span class="line">					<span class="string">"host"</span>: [</span><br><span class="line">						<span class="string">"127"</span>,</span><br><span class="line">						<span class="string">"0"</span>,</span><br><span class="line">						<span class="string">"0"</span>,</span><br><span class="line">						<span class="string">"1"</span></span><br><span class="line">					],</span><br><span class="line">					<span class="string">"port"</span>: <span class="string">"8000"</span>,</span><br><span class="line">					<span class="string">"path"</span>: [</span><br><span class="line">						<span class="string">"api"</span>,</span><br><span class="line">						<span class="string">"account"</span>,</span><br><span class="line">						<span class="string">"register"</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"response"</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"http://127.0.0.1:8000/api/account/login"</span>,</span><br><span class="line">			<span class="string">"request"</span>: &#123;</span><br><span class="line">				<span class="string">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">				<span class="string">"header"</span>: [</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="string">"key"</span>: <span class="string">"Content-Type"</span>,</span><br><span class="line">						<span class="string">"name"</span>: <span class="string">"Content-Type"</span>,</span><br><span class="line">						<span class="string">"value"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">						<span class="string">"type"</span>: <span class="string">"text"</span></span><br><span class="line">					&#125;,</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="string">"key"</span>: <span class="string">"x_token"</span>,</span><br><span class="line">						<span class="string">"value"</span>: <span class="string">"12345678"</span>,</span><br><span class="line">						<span class="string">"type"</span>: <span class="string">"text"</span></span><br><span class="line">					&#125;</span><br><span class="line">				],</span><br><span class="line">				<span class="string">"body"</span>: &#123;</span><br><span class="line">					<span class="string">"mode"</span>: <span class="string">"raw"</span>,</span><br><span class="line">					<span class="string">"raw"</span>: <span class="string">"&#123;\n\t\"username\":\"admin\",\n\t\"password\":\"12345678\"\n&#125;"</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"url"</span>: &#123;</span><br><span class="line">					<span class="string">"raw"</span>: <span class="string">"http://127.0.0.1:8000/api/account/login"</span>,</span><br><span class="line">					<span class="string">"protocol"</span>: <span class="string">"http"</span>,</span><br><span class="line">					<span class="string">"host"</span>: [</span><br><span class="line">						<span class="string">"127"</span>,</span><br><span class="line">						<span class="string">"0"</span>,</span><br><span class="line">						<span class="string">"0"</span>,</span><br><span class="line">						<span class="string">"1"</span></span><br><span class="line">					],</span><br><span class="line">					<span class="string">"port"</span>: <span class="string">"8000"</span>,</span><br><span class="line">					<span class="string">"path"</span>: [</span><br><span class="line">						<span class="string">"api"</span>,</span><br><span class="line">						<span class="string">"account"</span>,</span><br><span class="line">						<span class="string">"login"</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"response"</span>: []</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h2><p>Please see the <code>readme.md</code> file, there is step by step how to use or test this rest api skeleton.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>TotalJS has many example, but all of the examples is the simple way. Simple way is doesn’t same meaning as best practice. So how do I know about the best practice way? Just read correctly all the documentation from TotalJS and make research by yourself.</p><p>This rest api skeleton have uploaded into my github repository, You can just download this skeleton for your project at <a href="https://github.com/aalfiann/totaljs-rest-skeleton" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">here</a>.</p><p>If you have a question about this skeleton, feel free to ask me by leaving a comment below, or just create an issue in my github repository.</p><p>Thank You for your time to reading my article.</p></div></article></div><div id="safelinker2"></div><div id="adscustom"><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">Search</label></div><div class="search-result" id="search_result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a class="prev" href="/post/how-to-create-app-totaljs-with-mongoose-5/" title="How to Create App TotalJS with Mongoose 5">PREV</a><a class="next" href="/post/pros-and-cons-of-totaljs-framework/" title="Pros and Cons of TotalJS Framework">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url=window.location.href,this.page.identifier=window.location.href};!function(){var e=document,t=e.createElement("script");t.src="https://hexoder.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><div class="copyright"><p>© 2019 - 2021 <a href="/" target="_blank">Hexoder</a> | <a href="/disclaimer">Disclaimer</a> | <a href="/privacy-policy">Privacy</a> | <a href="/atom.xml">Feed</a> | <a href="/sitemap.xml">Sitemap</a></p><br><a class="dmca-badge" href="//www.dmca.com/Protection/Status.aspx?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" title="DMCA.com Protection Status"><img src="https://images.dmca.com/Badges/dmca_protected_sml_120m.png?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" alt="DMCA.com Protection Status"></a><script src="https://images.dmca.com/Badges/DMCABadgeHelper.min.js"></script></div><div class="totop"><i></i></div></div></footer><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/jquery-1.8.2.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/ar-anchor.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/main.js"></script><script src="//cdn.jsdelivr.net/npm/safelink-jquery@1.1.0/src/safelink.min.js"></script><script>$("#safelinker1").Safelink({encoded:link,timer:!0,firstButtonText:"Click Here First >>",secondButtonText:"Continue to Get Link >>"}).build("#safelinker2","btn-safelink btn-hoverable")</script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-151912342-1","auto"),ga("send","pageview")</script></body></html>