<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>How to Avoid JavaScript Heap Out of Memory · Hexoder</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="How to Avoid JavaScript Heap Out of Memory - M ABD AZIZ ALFIAN"><meta name="keywords" content="learning-javascript, tutorial-javascript, learning-nodejs, tutorial-nodejs, elementary-os, linux"><meta name="author" content="M ABD AZIZ ALFIAN"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/css/bubuzou.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://hexoder.com/atom.xml" title="Hexoder"><script src="//cdn.jsdelivr.net/npm/text-obfuscator@1.0.2/dist/text-obfuscator.min.js"></script><script>function parse_query_string(e){for(var o=e.replace("?","").split("&"),n={},r=0;r<o.length;r++){var t=o[r].split("="),i=decodeURIComponent(t[0]),a=decodeURIComponent(t[1]);if(void 0===n[i])n[i]=decodeURIComponent(a);else if("string"==typeof n[i]){var l=[n[i],decodeURIComponent(a)];n[i]=l}else n[i].push(decodeURIComponent(a))}return n}function removeParam(e,o){var n=o.split("?")[0],r=[],t=-1!==o.indexOf("?")?o.split("?")[1]:"";if(""!==t){for(var i=(r=t.split("&")).length-1;0<=i;i-=1)r[i].split("=")[0]===e&&r.splice(i,1);0<r.length?n=n+"?"+r.join("&"):n+=r.join("&")}return n}var hash=parse_query_string(window.location.search).to;if(hash){var link=TextObfuscator.decode(hash,3),newurl=removeParam("to",window.location.href);newurl=newurl.replace(window.location.origin,""),window.history.replaceState({},document.title,newurl)}</script><script data-ad-client="ca-pub-8811888720849913" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><header><div class="header row"><a class="logo-link" href="/"><img src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/images/logo-landscape.png"></a><ul class="nav nav-list" id="nav_list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self" data-hover="HOME">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self" data-hover="ABOUT">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self" data-hover="ARCHIVES">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/contact" target="_self" data-hover="CONTACT">CONTACT</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div class="nav-btn" id="nav_btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><div id="safelinker1"></div><div class="post" id="postAr"><article class="post-block"><h1 class="post-title">How to Avoid JavaScript Heap Out of Memory</h1><div class="post-info">2019-11-19</div><div class="post-content"><p><img src="https://i.imgur.com/PGbrPwe.jpg" alt=""></p><p>Hello guys, today I would like to write about How to Avoid JavaScript Heap Out of Memory in NodeJS.<br><code>JavaScript heap out of memory</code> is normally happend when you are reading very large file.<br>But sometimes this could happen when you are in big loop process to push data into array.</p><a id="more"></a><h2 id="What-is-JavaScript-Heap-Out-of-Memory"><a href="#What-is-JavaScript-Heap-Out-of-Memory" class="headerlink" title="What is JavaScript Heap Out of Memory?"></a>What is JavaScript Heap Out of Memory?</h2><p>JavaScript Heap Out of Memory means you have reach the limit of NodeJS memory usage. The strict standar limit memory usage in V8 is around 1.7 GB. So you have to increase this manually if you have reach this limit.</p><h2 id="Using-Stream"><a href="#Using-Stream" class="headerlink" title="Using Stream"></a>Using Stream</h2><p>When you are going to handle big file in NodeJS, the best practice is using <code>stream</code>. Because stream will break apart process into line per line, so the CPU can breath longer when processing big data. But using native <code>stream</code> is still not enough for very very large data file. You still get <code>JavaScript Heap Out of Memory</code>. So I going to describe what is the simple way and the best way of using stream to avoid JavaScript Heap Out of Memory below here.</p><h3 id="Simple-Way"><a href="#Simple-Way" class="headerlink" title="Simple Way"></a>Simple Way</h3><p>After I take a look searching through google and make some research. The very simple way to avoid JavaScript Heap Out of Memory in NodeJS is using <code>createReadStream</code>.</p><ul><li>Example for read file<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reader = fs.createReadStream(<span class="string">'your/path/file'</span>);</span><br><span class="line">reader.on(<span class="string">'data'</span>, (line) =&gt; &#123;</span><br><span class="line">  <span class="comment">// handle data line per line here</span></span><br><span class="line">&#125;);</span><br><span class="line">reader.on(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br><span class="line">reader.on(<span class="string">'done'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Reading file success!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul><p>If you’re file is under 400Mb, then above method is still work well. But how if you’re file is very large? like 1Gb or 2Gb in size? Actually this way is still fails (not working), you still get <code>JavaScript Heap Out of Memory</code>.</p><p>To solve this problem you should run extra arguments when executing your js.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --max-old-space-size=4096 yourFile.js</span><br></pre></td></tr></table></figure><p>Very simple way because you have already increase the strict standar limit of memory usage in NodeJS. This is working but actually I don’t recommend to use this way.</p><h3 id="Best-Way"><a href="#Best-Way" class="headerlink" title="Best Way"></a>Best Way</h3><p>So what is the best way to handle big file? The answer is turn your native stream into event stream.<br>Yeah I know this is not simple, but thanks to him, this guy name <code>Dominictarr</code> was created the <a href="https://www.npmjs.com/package/event-stream" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">event-stream</a> library which is this library is the best eficient way to play with stream in NodeJS.</p><p>Example for read file</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> es = <span class="built_in">require</span>(<span class="string">'event-stream'</span>);</span><br><span class="line"></span><br><span class="line">fs.createReadStream(<span class="string">'your/path/file'</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    es.mapSync(<span class="function"><span class="keyword">function</span>(<span class="params">line</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// handle data line per line here</span></span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .on(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Reading file success!'</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>I successfully to read log file around 2Gb in size with this way without have to set</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--max-old-space-size=4096</span><br></pre></td></tr></table></figure><h3 id="Big-JSON-File-Problem"><a href="#Big-JSON-File-Problem" class="headerlink" title="Big JSON File Problem"></a>Big JSON File Problem</h3><p>I facing another issue when the file is json string. That above method is very slow, it is because to parse your data to json object. But thanks to him again, <code>Dominictarr</code> create another <a href="https://www.npmjs.com/package/JSONStream" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">JSONStream</a> library which is to improve the performance in <code>event-stream</code> while parsing to json object.</p><p>Example to parse big json</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> es = <span class="built_in">require</span>(<span class="string">'event-stream'</span>);</span><br><span class="line"><span class="keyword">const</span> jsonStream = <span class="built_in">require</span>(<span class="string">'JSONStream'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> json = [];</span><br><span class="line">fs.createReadStream(<span class="string">'your/path/file'</span>)</span><br><span class="line">  .pipe(jsonStream.parse())</span><br><span class="line">  .pipe(</span><br><span class="line">    es.mapSync(<span class="function"><span class="keyword">function</span>(<span class="params">line</span>) </span>&#123;</span><br><span class="line">      json.push(line);</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .on(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Reading file success!'</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><code>event-stream</code> + <code>JSONStream</code> will make improve the performance speed 3x faster for parsing string to json object.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Using stream is the best practice to handle big data. But not for speed. Even you are successfully to avoid JavaScript Heap Out of Memory in NodeJS, reading big file is always slow.</p><p>Always remember that, just stop or better don’t ever think to use file for saving big data in the future. If right now you having big file for example like log file, just try to move it into database engine like <code>ElasticSearch</code> or <code>Hadoop</code>. This will make your life easier to manage your log data.</p><p>Thank You.</p></div></article></div><div id="safelinker2"></div><div id="adscustom"><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">Search</label></div><div class="search-result" id="search_result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a class="prev" href="/post/introduction-about-jsonql-in-nodejs/" title="Introduction About JsonQL in NodeJS">PREV</a><a class="next" href="/post/how-to-json-query-in-javascript/" title="How to JSON Query in JavaScript">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url=window.location.href,this.page.identifier=window.location.href};!function(){var e=document,t=e.createElement("script");t.src="https://hexoder.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><div class="copyright"><p>© 2019 - 2021 <a href="/" target="_blank">Hexoder</a> | <a href="/disclaimer">Disclaimer</a> | <a href="/privacy-policy">Privacy</a> | <a href="/atom.xml">Feed</a> | <a href="/sitemap.xml">Sitemap</a></p><br><a class="dmca-badge" href="//www.dmca.com/Protection/Status.aspx?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" title="DMCA.com Protection Status"><img src="https://images.dmca.com/Badges/dmca_protected_sml_120m.png?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" alt="DMCA.com Protection Status"></a><script src="https://images.dmca.com/Badges/DMCABadgeHelper.min.js"></script></div><div class="totop"><i></i></div></div></footer><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/jquery-1.8.2.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/ar-anchor.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/main.js"></script><script src="//cdn.jsdelivr.net/npm/safelink-jquery@1.1.0/src/safelink.min.js"></script><script>$("#safelinker1").Safelink({encoded:link,timer:!0,firstButtonText:"Click Here First >>",secondButtonText:"Continue to Get Link >>"}).build("#safelinker2","btn-safelink btn-hoverable")</script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-151912342-1","auto"),ga("send","pageview")</script></body></html>