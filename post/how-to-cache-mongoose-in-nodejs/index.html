<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>How to Cache Mongoose in NodeJS · Hexoder</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="How to Cache Mongoose in NodeJS - M ABD AZIZ ALFIAN"><meta name="keywords" content="learning-javascript, tutorial-javascript, learning-nodejs, tutorial-nodejs, elementary-os, linux"><meta name="author" content="M ABD AZIZ ALFIAN"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/css/bubuzou.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://hexoder.com/atom.xml" title="Hexoder"><script src="//cdn.jsdelivr.net/npm/text-obfuscator@1.0.2/dist/text-obfuscator.min.js"></script><script>function parse_query_string(e){for(var o=e.replace("?","").split("&"),n={},r=0;r<o.length;r++){var t=o[r].split("="),i=decodeURIComponent(t[0]),a=decodeURIComponent(t[1]);if(void 0===n[i])n[i]=decodeURIComponent(a);else if("string"==typeof n[i]){var l=[n[i],decodeURIComponent(a)];n[i]=l}else n[i].push(decodeURIComponent(a))}return n}function removeParam(e,o){var n=o.split("?")[0],r=[],t=-1!==o.indexOf("?")?o.split("?")[1]:"";if(""!==t){for(var i=(r=t.split("&")).length-1;0<=i;i-=1)r[i].split("=")[0]===e&&r.splice(i,1);0<r.length?n=n+"?"+r.join("&"):n+=r.join("&")}return n}var hash=parse_query_string(window.location.search).to;if(hash){var link=TextObfuscator.decode(hash,3),newurl=removeParam("to",window.location.href);newurl=newurl.replace(window.location.origin,""),window.history.replaceState({},document.title,newurl)}</script><script data-ad-client="ca-pub-8811888720849913" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><header><div class="header row"><a class="logo-link" href="/"><img src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/images/logo-landscape.png"></a><ul class="nav nav-list" id="nav_list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self" data-hover="HOME">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self" data-hover="ABOUT">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self" data-hover="ARCHIVES">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/contact" target="_self" data-hover="CONTACT">CONTACT</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div class="nav-btn" id="nav_btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><div id="safelinker1"></div><div class="post" id="postAr"><article class="post-block"><h1 class="post-title">How to Cache Mongoose in NodeJS</h1><div class="post-info">2020-12-30</div><div class="post-content"><p><img src="https://i.imgur.com/3d6lwwi.jpg" alt=""></p><p>Hello guys, today I want to write an article about How to cache mongoose in NodeJS. Why? Because using cache will give you much benefit and actualy saving your cost bandwidth. So, in this article we will learn how to create a cache for mongoose using in memory, redis or filebased.</p><a id="more"></a><h3 id="Reason-to-Cache"><a href="#Reason-to-Cache" class="headerlink" title="Reason to Cache"></a>Reason to Cache</h3><ul><li><p><strong>Mongoose doesn’t cache query</strong><br>As default, mongoose doesn’t have a cache feature but they have a Model.Hydrate. So we have to create or use other library to make this work.</p></li><li><p><strong>Save your Database</strong><br>In high traffic, your database will be dead if you doesn’t cache your query result. Even you have a super database server, this won’t help much except you have a cache mechanism.</p></li><li><p><strong>Saving Cost</strong><br>With using cache, the request hit to database server will be slowdown, so you will save the bandwidth and of course it will saving your cost.</p></li></ul><h3 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR"></a>TLDR</h3><p>Just use this library &gt;&gt; <a href="https://github.com/aalfiann/recachegoose" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">recachegoose</a>.</p><h3 id="How-mongoose-Cache-Work-with-Hydrate"><a href="#How-mongoose-Cache-Work-with-Hydrate" class="headerlink" title="How mongoose Cache Work with Hydrate"></a>How mongoose Cache Work with Hydrate</h3><p>Please see <a href="https://mongoosejs.com/docs/api.html#model_Model.hydrate" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">https://mongoosejs.com/docs/api.html#model_Model.hydrate</a>.</p><p>Unfortunately, the official mongoose documentations doesn’t explain much about this, so I will make this easy to understand with two examples below.</p><ul><li><p>Example Simple Model</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set cache</span></span><br><span class="line"><span class="keyword">let</span> todo = Todo.findById(id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// now todo has a query and then we need to save into redis</span></span><br><span class="line">redis.set(key, todo); <span class="comment">// stores as raw json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// read cache</span></span><br><span class="line"><span class="keyword">let</span> todoCache = redis.get(key); <span class="comment">// returns as raw json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now we have a cached result from redis then have to return to model with hydrate</span></span><br><span class="line"><span class="keyword">let</span> todo = Todo.hydrate(todoCache); <span class="comment">// converts in to mongoose model</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now todo already converted to model so we are able to use it as model</span></span><br><span class="line"><span class="keyword">let</span> createdBy = todo.populate(<span class="string">'createdBy'</span>);</span><br></pre></td></tr></table></figure></li><li><p>Example of Array Model</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set cache</span></span><br><span class="line"><span class="keyword">let</span> todos = Todo.findAll();</span><br><span class="line"></span><br><span class="line"><span class="comment">// now todo has a query and then we need to save into redis</span></span><br><span class="line">redis.set(<span class="string">'todos'</span>, todos); <span class="comment">// stores as array of json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// read cache</span></span><br><span class="line"><span class="keyword">let</span> cachedTodos = redis.get(<span class="string">'todos'</span>); <span class="comment">// returns as array of json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now we have a cached result from redis then have to return to model with hydrate</span></span><br><span class="line"><span class="keyword">let</span> todos = cachedTodos.map(<span class="function"><span class="params">todo</span> =&gt;</span> Todo.hydrate(todo)); <span class="comment">// converts in to mongoose model</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now todo already converted to model so we are able to use it as model</span></span><br><span class="line"><span class="comment">// for this example assume that we filter for todo that already done</span></span><br><span class="line"><span class="keyword">let</span> incompleteTodos = todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.isDone);</span><br></pre></td></tr></table></figure></li></ul><p>That’s very easy right?<br>But don’t use above code in your application, we have better way with using <a href="http://github.com/aalfiann/recachegoose" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">recachegoose</a>.</p><h3 id="Using-recachegoose"><a href="#Using-recachegoose" class="headerlink" title="Using recachegoose"></a>Using recachegoose</h3><p><a href="http://github.com/aalfiann/recachegoose" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">recachegoose</a> is a library for mongoose cache in memory, redis or filebased.</p><ul><li><p>In memory</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> cachegoose = <span class="built_in">require</span>(<span class="string">'recachegoose'</span>);</span><br><span class="line"></span><br><span class="line">cachegoose(mongoose, &#123; <span class="attr">engine</span>: <span class="string">'memory'</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>With File</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> cachegoose = <span class="built_in">require</span>(<span class="string">'recachegoose'</span>);</span><br><span class="line"></span><br><span class="line">cachegoose(mongoose, &#123; <span class="attr">engine</span>: <span class="string">'file'</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>With Redis</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> cachegoose = <span class="built_in">require</span>(<span class="string">'recachegoose'</span>);</span><br><span class="line"></span><br><span class="line">cachegoose(mongoose, &#123;</span><br><span class="line">  engine: <span class="string">'redis'</span>,</span><br><span class="line">  port: <span class="number">6379</span>,</span><br><span class="line">  host: <span class="string">'localhost'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or with redis connection string</span></span><br><span class="line">cachegoose(mongoose, &#123;</span><br><span class="line">  engine: <span class="string">'redis'</span>,</span><br><span class="line">  client: <span class="built_in">require</span>(<span class="string">'redis'</span>).createClient(<span class="string">'redis://localhost:6379'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>Usage Cache</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Record</span><br><span class="line">  .find(&#123; <span class="attr">some_condition</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  .cache(<span class="number">30</span>) <span class="comment">// The number of seconds to cache the query.  Defaults to 60 seconds.</span></span><br><span class="line">  .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, records</span>) </span>&#123; <span class="comment">// you are able to use callback exec or promise</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">Record</span><br><span class="line">  .aggregate()</span><br><span class="line">  .group(&#123; <span class="attr">total</span>: &#123; <span class="attr">$sum</span>: <span class="string">'$some_field'</span> &#125; &#125;)</span><br><span class="line">  .cache(<span class="number">0</span>) <span class="comment">// Explicitly passing in 0 will cache the results indefinitely.</span></span><br><span class="line">  .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, aggResults</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></li><li><p>Cache with Custom Key</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userId = <span class="string">'1234567890'</span>;</span><br><span class="line"></span><br><span class="line">Children</span><br><span class="line">  .find(&#123; <span class="attr">parentId</span>: userId &#125;)</span><br><span class="line">  .cache(<span class="number">0</span>, userId + <span class="string">'-children'</span>) <span class="comment">/* Will create a redis entry          */</span></span><br><span class="line">  .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, records</span>) </span>&#123;  <span class="comment">/* with the key '1234567890-children' */</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">ChildrenSchema.post(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">child</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Clear the parent's cache, since a new child has been added.</span></span><br><span class="line">  cachegoose.clearCache(child.parentId + <span class="string">'-children'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>Clearing Cache</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cachegoose.clearCache(<span class="string">'your_key'</span>, callback); <span class="comment">// callback is optional</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>After you know how to create a cache mechanism to mongoose, of course you can create your own library by yourself. But just don’t reinvent the wheels. Doing mongoose cache with recachegoose is very easy, clean and save your time. recachegoose already support multiple cache mechanism, you are able to use in memory, redis or filebased cache. But I don’t recommend to use filebased cache because I know it fast but it doesn’t scalable.</p><p>Actualy recachegoose is originally named as <a href="https://github.com/boblauer/cachegoose" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">cachegoose</a> and created by <strong>Boblauer</strong>, but I forked this because it seems was inactive for 2 years ago (since I write this article). I choose cachegoose library because based on <a href="http://github.com/cayasso/cacheman" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">Cacheman</a> which is they support multiple engine for caching. Unfortunately Cacheman library seems was inactive and too old, so I forked this too and called <a href="https://github.com/aalfiann/recacheman" target="_blank" target="_blank" target="_blank" rel="noopener external nofollow noopener noreferrer">recacheman</a>.</p><p>In this forked version of cachegoose, I’ve modified many things:</p><ul><li>Removed old and unnecessary libraries.</li><li>Fixed some bugs.</li><li>Fixed vulnerable on dependencies.</li><li>Improved performance.</li><li>Update unit test because of deprecated function.</li></ul><p>I will welcome for any PR and fast response to solve any issues for this project because I also used this library for my important project.</p><p>If you having problem or still not understanding how to create a cache to mongoose, just feel free to leave a comment below.</p><p>Thank you for reading my article.</p></div></article></div><div id="safelinker2"></div><div id="adscustom"><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div><div><iframe src="https://imgfo.com/featured-box-embed.html" width="300px" height="250px" frameborder="0" scrolling="no" style="max-width:300px!important"></iframe></div></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">Search</label></div><div class="search-result" id="search_result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a class="prev" href="/post/list-unlimited-free-image-cdn/" title="List Unlimited Free Image CDN">PREV</a><a class="next" href="/post/how-to-install-phantomjs-in-elementary-os-5/" title="How to Install PhantomJS in Elementary OS 5">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url=window.location.href,this.page.identifier=window.location.href};!function(){var e=document,t=e.createElement("script");t.src="https://hexoder.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><div class="copyright"><p>© 2019 - 2021 <a href="/" target="_blank">Hexoder</a> | <a href="/disclaimer">Disclaimer</a> | <a href="/privacy-policy">Privacy</a> | <a href="/atom.xml">Feed</a> | <a href="/sitemap.xml">Sitemap</a></p><br><a class="dmca-badge" href="//www.dmca.com/Protection/Status.aspx?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" title="DMCA.com Protection Status"><img src="https://images.dmca.com/Badges/dmca_protected_sml_120m.png?ID=eb23d7cc-74cc-4a2f-8e4d-d4676a061313" alt="DMCA.com Protection Status"></a><script src="https://images.dmca.com/Badges/DMCABadgeHelper.min.js"></script></div><div class="totop"><i></i></div></div></footer><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/jquery-1.8.2.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/ar-anchor.min.js"></script><script src="//cdn.jsdelivr.net/gh/aalfiann/hexoder@gh-pages/scripts/main.js"></script><script src="//cdn.jsdelivr.net/npm/safelink-jquery@1.1.0/src/safelink.min.js"></script><script>$("#safelinker1").Safelink({encoded:link,timer:!0,firstButtonText:"Click Here First >>",secondButtonText:"Continue to Get Link >>"}).build("#safelinker2","btn-safelink btn-hoverable")</script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-151912342-1","auto"),ga("send","pageview")</script></body></html>